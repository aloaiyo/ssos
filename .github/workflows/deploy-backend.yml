name: Deploy Backend to EC2

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e  # ÏóêÎü¨ Î∞úÏÉù Ïãú Ï¶âÏãú Ï§ëÎã®
            export PATH="$HOME/.local/bin:$PATH"

            echo "========================================="
            echo "üöÄ Starting deployment..."
            echo "========================================="

            cd ~/ssos/backend

            # 1. Pull latest code
            echo ""
            echo "üì• Pulling latest code..."
            git pull origin main

            # 2. Setup environment
            echo ""
            echo "‚öôÔ∏è Setting up environment..."
            if [ -f .env.production ]; then
              cp .env.production .env
              echo "‚úÖ Using .env.production"
            else
              echo "‚ùå .env.production not found!"
              echo "   Create .env.production with required settings:"
              echo "   - DATABASE_URL or USE_AWS_SSM=true"
              exit 1
            fi

            # 3. Validate and setup environment variables
            echo ""
            echo "üîç Validating environment..."

            # Check if using SSM or local env
            if grep -q "USE_AWS_SSM=true" .env 2>/dev/null; then
              echo "   Mode: AWS SSM Parameter Store"
              # Verify SSM access
              if ! aws sts get-caller-identity --region ap-northeast-2 > /dev/null 2>&1; then
                echo "‚ùå EC2 cannot access AWS. IAM Role required!"
                echo "   Attach IAM Role with AmazonSSMReadOnlyAccess to EC2 instance"
                exit 1
              fi
              echo "‚úÖ AWS access verified"

              # Get SSM prefix from .env
              SSM_PREFIX=$(grep "^SSM_PREFIX=" .env | cut -d'=' -f2 || echo "/ssos/prod")

              # Load DATABASE_URL from SSM for aerich CLI
              echo "   Loading DATABASE_URL from SSM..."
              export DATABASE_URL=$(aws ssm get-parameter --name "${SSM_PREFIX}/database_url" --with-decryption --query "Parameter.Value" --output text --region ap-northeast-2)
              if [ -z "$DATABASE_URL" ] || [ "$DATABASE_URL" = "None" ]; then
                echo "‚ùå DATABASE_URL not found in SSM!"
                exit 1
              fi
              echo "‚úÖ DATABASE_URL loaded from SSM"
            else
              echo "   Mode: Local environment variables"
              # Verify DATABASE_URL exists and export it
              if ! grep -q "^DATABASE_URL=" .env 2>/dev/null; then
                echo "‚ùå DATABASE_URL not found in .env!"
                echo "   Add DATABASE_URL to .env.production or enable SSM mode"
                exit 1
              fi
              export DATABASE_URL=$(grep "^DATABASE_URL=" .env | cut -d'=' -f2-)
              echo "‚úÖ DATABASE_URL found"
            fi

            # 4. Install dependencies
            echo ""
            echo "üì¶ Installing dependencies..."
            poetry install --only main --no-root

            # 5. Test app can start
            echo ""
            echo "üß™ Testing application..."
            if ! poetry run python -c "from app.main import app; print('‚úÖ App imports OK')"; then
              echo "‚ùå Application failed to import!"
              echo "   Check for syntax errors or missing dependencies"
              exit 1
            fi

            # 6. Run migrations
            echo ""
            echo "üóÑÔ∏è Running database migrations..."

            # Check if model tables exist (users table = models initialized)
            TABLES_EXIST=$(poetry run python -c "
            import asyncio
            import os
            from tortoise import Tortoise

            async def check():
                db_url = os.environ.get('DATABASE_URL')
                await Tortoise.init(db_url=db_url, modules={'models': []})
                conn = Tortoise.get_connection('default')
                try:
                    result = await conn.execute_query(\"SELECT EXISTS(SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users')\")
                    exists = result[1][0]['exists']
                    print('exists' if exists else 'not_exists')
                except Exception as e:
                    print('error')
                await Tortoise.close_connections()

            asyncio.run(check())
            " 2>&1 | tail -1)

            echo "   Model tables check: $TABLES_EXIST"

            if [ "$TABLES_EXIST" = "not_exists" ]; then
              echo "   Model tables not found. Running aerich init-db..."
              if poetry run aerich init-db 2>&1; then
                echo "‚úÖ Database initialized with all tables"
              else
                echo "‚ùå Database initialization failed!"
                exit 1
              fi
            elif [ "$TABLES_EXIST" = "exists" ]; then
              echo "   Model tables exist. Running aerich upgrade..."
              MIGRATION_OUTPUT=$(poetry run aerich upgrade 2>&1) || true
              echo "$MIGRATION_OUTPUT"
              echo "‚úÖ Migrations applied"
            else
              echo "‚ùå Cannot connect to database!"
              echo "   DATABASE_URL: ${DATABASE_URL:0:30}..."
              exit 1
            fi

            # Verify tables count
            TABLE_COUNT=$(poetry run python -c "
            import asyncio
            import os
            from tortoise import Tortoise

            async def count():
                db_url = os.environ.get('DATABASE_URL')
                await Tortoise.init(db_url=db_url, modules={'models': []})
                conn = Tortoise.get_connection('default')
                result = await conn.execute_query(\"SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public'\")
                print(result[1][0]['count'])
                await Tortoise.close_connections()

            asyncio.run(count())
            " 2>/dev/null || echo "0")

            echo "   Tables in database: $TABLE_COUNT"
            if [ "$TABLE_COUNT" -lt 10 ]; then
              echo "‚ö†Ô∏è Warning: Expected more tables (got $TABLE_COUNT). Check init-db output."
            else
              echo "‚úÖ Database schema verified ($TABLE_COUNT tables)"
            fi

            # 7. Setup systemd service
            echo ""
            echo "üîß Configuring systemd service..."
            printf '%s\n' \
              '[Unit]' \
              'Description=SSOS Backend API' \
              'After=network.target' \
              '' \
              '[Service]' \
              'Type=simple' \
              'User=ubuntu' \
              'WorkingDirectory=/home/ubuntu/ssos/backend' \
              'Environment="PATH=/home/ubuntu/.local/bin:/usr/local/bin:/usr/bin:/bin"' \
              'EnvironmentFile=/home/ubuntu/ssos/backend/.env' \
              'ExecStart=/home/ubuntu/.local/bin/poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000' \
              'Restart=always' \
              'RestartSec=3' \
              'StandardOutput=journal' \
              'StandardError=journal' \
              '' \
              '[Install]' \
              'WantedBy=multi-user.target' | sudo tee /etc/systemd/system/ssos-backend.service > /dev/null
            sudo systemctl daemon-reload
            sudo systemctl enable ssos-backend
            echo "‚úÖ systemd service configured"

            # 8. Restart service
            echo ""
            echo "üîÑ Restarting service..."
            sudo systemctl restart ssos-backend

            # 9. Wait and verify
            echo ""
            echo "‚è≥ Waiting for service to start..."
            sleep 5

            # Check service status
            if sudo systemctl is-active --quiet ssos-backend; then
              echo "‚úÖ Service is running"

              # Health check
              for i in 1 2 3; do
                if curl -sf http://localhost:8000/docs > /dev/null 2>&1; then
                  echo ""
                  echo "========================================="
                  echo "‚úÖ Deployment completed successfully!"
                  echo "========================================="
                  exit 0
                fi
                echo "   Attempt $i/3: Waiting for API..."
                sleep 2
              done

              echo "‚ö†Ô∏è Service running but API not responding"
            else
              echo "‚ùå Service failed to start"
            fi

            # Debug info on failure
            echo ""
            echo "========================================="
            echo "‚ùå Deployment failed. Debug info:"
            echo "========================================="
            echo ""
            echo "--- Service Status ---"
            sudo systemctl status ssos-backend --no-pager || true
            echo ""
            echo "--- Recent Logs ---"
            sudo journalctl -u ssos-backend -n 50 --no-pager || true
            exit 1
