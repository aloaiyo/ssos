name: Deploy Backend to EC2

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # 수동 실행 가능

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            export PATH="$HOME/.local/bin:$PATH"
            cd ~/ssos/backend

            # Pull latest code
            git pull origin main

            # Copy production env if exists
            if [ -f .env.production ]; then
              cp .env.production .env
              echo "Using .env.production"
            else
              echo "⚠️ .env.production not found, using existing .env"
            fi

            # Verify environment configuration
            echo "Checking environment configuration..."
            if grep -q "USE_AWS_SSM=true" .env 2>/dev/null; then
              echo "✅ SSM mode enabled"
              # Verify SSM access
              if aws ssm get-parameter --name "/ssos/prod/database_url" --region ap-northeast-2 --query "Parameter.Name" --output text 2>/dev/null; then
                echo "✅ SSM access verified"
              else
                echo "⚠️ SSM access may not be configured (EC2 IAM Role required)"
              fi
            else
              echo "ℹ️ Using local environment variables"
            fi

            # Install dependencies
            poetry install --only main --no-root

            # Run migrations with proper error handling
            echo "Running database migrations..."
            MIGRATION_OUTPUT=$(poetry run aerich upgrade 2>&1) || true
            MIGRATION_EXIT=$?
            echo "$MIGRATION_OUTPUT"

            if echo "$MIGRATION_OUTPUT" | grep -q "No upgrade items found"; then
              echo "✅ Database is up to date"
            elif echo "$MIGRATION_OUTPUT" | grep -q "Success upgrade"; then
              echo "✅ Migrations applied successfully"
            elif [ $MIGRATION_EXIT -ne 0 ]; then
              echo "⚠️ Migration warning, attempting init-db..."
              if poetry run aerich init-db 2>&1; then
                echo "✅ Database initialized successfully"
              else
                echo "❌ Migration failed! Check database connection and credentials."
                exit 1
              fi
            else
              echo "✅ Migrations completed"
            fi

            # systemd 서비스 파일 생성/업데이트
            echo "Setting up systemd service..."
            cat << 'SERVICEEOF' | sudo tee /etc/systemd/system/ssos-backend.service > /dev/null
[Unit]
Description=SSOS Backend API
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/ssos/backend
Environment="PATH=/home/ubuntu/.local/bin:/usr/local/bin:/usr/bin:/bin"
EnvironmentFile=/home/ubuntu/ssos/backend/.env
ExecStart=/home/ubuntu/.local/bin/poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
SERVICEEOF
            sudo systemctl daemon-reload
            sudo systemctl enable ssos-backend
            echo "✅ systemd service configured"

            # 서비스 재시작
            sudo systemctl restart ssos-backend
            sleep 3

            # Verify server is running
            if sudo systemctl is-active --quiet ssos-backend && curl -s http://localhost:8000/docs > /dev/null; then
              echo "✅ Backend deployment completed!"
            else
              echo "⚠️ Service status:"
              sudo systemctl status ssos-backend --no-pager
            fi
